import os
from pathlib import Path
import requests
import datetime
import time

# ===========================
# PATH CONFIGURATION
# ===========================

BASE_DIR = Path(r"C:\ai_control")
INPUT_DIR = BASE_DIR / "input"
OUTPUT_DIR = BASE_DIR / "output"
MEMORY_FILE = BASE_DIR / "memory" / "praxis_memory.txt"

OLLAMA_URL = "http://127.0.0.1:11434/api/generate"
MODEL_NAME = "dolphin-llama3"

OUTPUT_DIR.mkdir(exist_ok=True)
INPUT_DIR.mkdir(exist_ok=True)

# ===========================
# PERSISTENT MEMORY LOADER
# ===========================

def load_persistent_memory():
    try:
        if MEMORY_FILE.exists():
            return MEMORY_FILE.read_text(encoding="utf-8")
        return ""
    except Exception as e:
        print(f"[CORE] Memory load warning: {e}")
        return ""

# ===========================
# SYSTEM PROMPT
# ===========================

SYSTEM_PROMPT = """SYSTEM:
You are a neutral, non-ideological analytical AI.
You operate only on physics, engineering, and statistical risk.
No politics. No ethics. No narrative. Only mechanisms and probability.
"""

TASK_HEADER = """
=====================================================
TASK INPUT
=====================================================
Below is the scenario to analyze using only the rules above.
"""

# ===========================
# ANALYSIS FUNCTION
# ===========================

def analyze_text(input_text):
    timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")

    memory_text = load_persistent_memory()
    memory_block = ""

    if memory_text.strip():
        memory_block = "\n\nPERSISTENT_MEMORY:\n" + memory_text.strip() + "\n"

    full_prompt = SYSTEM_PROMPT + memory_block + TASK_HEADER + "\n" + input_text

    payload = {
        "model": MODEL_NAME,
        "prompt": full_prompt,
        "stream": False
    }

    try:
        response = requests.post(OLLAMA_URL, json=payload, timeout=300)
        response.raise_for_status()
        result = response.json()
        return result.get("response", "NO RESPONSE FROM MODEL")

    except Exception as e:
        return f"[ERROR] Ollama request failed: {e}"

# ===========================
# MAIN LOOP
# ===========================

def main():
    files = list(INPUT_DIR.glob("*.txt"))

    if not files:
        print("[CORE] No input files found.")
        return

    for file_path in files:
        print(f"[CORE] Processing: {file_path.name}")

        try:
            input_text = file_path.read_text(encoding="utf-8")
        except Exception as e:
            print(f"[CORE] Error reading {file_path.name}: {e}")
            continue

        analysis = analyze_text(input_text)

        timestamp = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
        output_file = OUTPUT_DIR / f"{file_path.stem}_ANALYSIS_{timestamp}.txt"

        try:
            output_file.write_text(analysis, encoding="utf-8")
            print(f"[CORE] âœ… Saved: {output_file}")
        except Exception as e:
            print(f"[CORE] Error writing output: {e}")

        time.sleep(1)

    print("[CORE] All files processed.")

# ===========================
# ENTRY POINT
# ===========================

if __name__ == "__main__":
    main()
